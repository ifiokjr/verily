# Verily Technical Requirements

This document details the technical specifications, architecture, and technologies for the Verily ecosystem.

## 1. Architecture Overview

Verily employs a monorepo structure containing distinct applications and shared packages.

- **`/apps`:** Contains the end-user applications.
  - `verily_create`: The Flutter web application for creators.
  - `verily`: The primary Flutter mobile application for action verification.
  - `reflexy`: The Flutter demo game application showcasing package usage.
- **`/packages`:** Contains reusable Flutter components.
  - `verily_device_motion`: Package for accelerometer/gyroscope access and verification.
  - `verily_face_detection`: Package for ML Kit face detection.
  - `verily_pose_detection`: Package for ML Kit pose detection (body landmarks).
  - `verily_location`: Package for GPS/location verification.
  - `verily_camera`: Core camera handling utilities (used by other vision packages).
  - `verily_audio`: Package for microphone access and basic audio analysis/verification (if needed).
  - (Potentially others: `verily_nfc`, `verily_bluetooth`, `verily_barcode_scanning`, `verily_text_recognition`, `verily_object_detection`, etc., based on ML Kit capabilities and use cases).
- **`/backend`:** Contains the Serverpod backend project (typically includes `verily_server`, `verily_client`, `verily_flutter` subdirectories).
- **`/setup`:** Contains requirement documents, tasks, and setup scripts.
- **`/migrations`:** Contains database migration files generated by Serverpod.

## 2. Frontend (Flutter)

### 2.1. Applications (`/apps`)

- **Platform:** Flutter (using `fvm` for version management).
- **State Management:** Riverpod (Leveraging the `flutter` rule).
- **API Communication:** Via the generated Serverpod client located in `/backend/verily_client`.
- **Core Dependencies:**
  - `flutter_riverpod`
  - `serverpod_flutter` (dependency for using the Serverpod client)
  - Dependencies on relevant `/packages/verily_*` sensor/ML packages.
  - `permission_handler`: For requesting sensor permissions.
  - `uni_links` or similar: For handling deep linking to open the `Verily` app.
- **Build/Distribution:** Standard Flutter build processes. Consider Shorebird for future over-the-air updates.

### 2.2. Packages (`/packages`)

- **Type:** Primarily Flutter Packages.
- **Purpose:** Encapsulate specific sensor access and ML verification logic.
- **Key Dependencies (within relevant packages):**
  - `google_ml_kit_*` suite (e.g., `google_mlkit_face_detection`, `google_mlkit_pose_detection`).
  - `sensors_plus` (in `verily_device_motion`).
  - `geolocator` (in `verily_location`).
  - `camera` (core dependency, likely managed in `verily_camera` or directly in vision packages).
  - Potentially `nfc_manager`, `flutter_blue_plus`, `flutter_nearby_connections`, etc., for respective packages.
- **Design:** Sensor/ML packages should expose a clear, high-level API.

## 3. Backend (Dart + Serverpod)

- **Runtime:** Dart
- **Framework:** Serverpod (https://docs.serverpod.dev/)
- **Dependencies:**
  - `serverpod`
  - `serverpod_auth_server` (and potentially other auth modules like `serverpod_auth_email_server`)
  - `serverpod_postgres` (or other database drivers if needed)
- **Structure:** Standard Serverpod project structure located in `/backend/`:
  - `verily_server`: Contains the main server logic, endpoints, and model definitions (`*.spy.yaml`).
  - `verily_client`: Contains the auto-generated Dart client library for Flutter apps.
  - `verily_flutter`: Contains shared Flutter utility code generated by Serverpod (often minimal).
  - `config/`: Server configuration files (`development.yaml`, `production.yaml`, `passwords.yaml`).
  - `generated/`: Auto-generated code based on models and protocol definitions.
  - `lib/src/endpoints/`: Location for custom server endpoint definitions.
  - `lib/src/models/`: Location for `.spy.yaml` files defining data models and the protocol.
- **Data Storage:**
  - **Primary:** PostgreSQL (recommended and well-supported by Serverpod).
  - **ORM:** Serverpod's built-in ORM, generating Dart code from `.spy.yaml` model definitions.
  - **Migrations:** Handled via the `serverpod` CLI (`serverpod create-migration`, `serverpod apply-migrations`).
- **Schema:** (Defined in `lib/src/models/*.spy.yaml`)
  - `Creator`: Stores creator information and authentication details (likely leveraging `serverpod_auth` module tables).
  - `Action`: Stores definition of verifiable actions (name, description, configuration).
  - `ActionStep`: Stores individual steps within an action (type, parameters, order).
  - `Webhook`: Stores creator-defined webhooks (URL, associated action/events, secret).
  - `VerificationAttempt`: Logs attempts to complete actions (user identifier, status, timestamps, progress).
- **Authentication:**
  - Handled primarily via Serverpod's authentication modules (e.g., `serverpod_auth_server`, `serverpod_auth_email_server`). Requires corresponding Flutter packages (`serverpod_auth_shared_flutter`, `serverpod_auth_email_flutter`).
  - Custom authentication logic can be implemented in Endpoints and middleware if needed.
- **Webhook Dispatch:** Logic implemented within Serverpod Endpoints. Can utilize Serverpod Futures or background tasks for reliable, asynchronous dispatch and retries.
- **Deployment:**
  - Docker containerization (recommended, `Dockerfile` often included in Serverpod templates).
  - Deployment to cloud platforms (Fly.io, Google Cloud Run, AWS Fargate, etc.) following standard Dart server deployment practices and Serverpod documentation.

## 4. Machine Learning

- **Primary:** Google ML Kit suite via Flutter plugins for on-device analysis.
  - Face Detection
  - Pose Detection
  - Consider others: Text Recognition, Barcode Scanning, Object Detection, Selfie Segmentation based on defined verification actions.
- **Secondary:** Core ML (iOS) / TensorFlow Lite (Android/general) - Only if custom models or specific platform optimizations are absolutely necessary.

## 5. Testing Strategy

- **Unit Tests (Dart/Flutter):** For business logic within Flutter packages and apps (view models, Riverpod providers, utility functions).
- **Widget Tests (Flutter):** For UI components in isolation.
- **Backend Tests (Dart/Serverpod):** Using Dart's `test` package for Serverpod endpoints, database interactions, and business logic within the `verily_server` package.
- **Integration Tests (Flutter):** Can test app navigation and state flow, potentially mocking the Serverpod client or using a test instance of the Serverpod server.
- **Manual Testing (via `Reflexy`):** Primary method for testing core sensor and ML verification functionality on physical devices.
- **End-to-End (E2E):** Manual E2E tests involving creator app -> Serverpod backend -> Verily App -> Serverpod backend -> webhook notification flow.
